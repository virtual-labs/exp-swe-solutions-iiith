<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; style-src 'self' 'unsafe-inline' https: data:;">
    <title>Quantum Wavefunction Virtual Lab - Interactive Experiment</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../style.css">
    <link rel="stylesheet" type="text/css" href="../css/visualizer.css">
    <style>
        /* Quantum Lab specific styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3a 50%, #2d1b69 100%);
            min-height: 100vh;
            padding: 12px;
            font-family: 'Poppins', sans-serif;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 18px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 12px;
        }

        .title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .experiment-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 18px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 8px;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #6b7280;
        }

        .tab.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .experiment-content {
            display: none;
        }

        .experiment-content.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 15px;
        }

        .visualization-area {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 16px;
            padding: 20px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            min-height: 500px;
        }

        .controls-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .control-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .control-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            margin: 4px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-preset {
            padding: 8px 12px;
            font-size: 12px;
            text-align: center;
        }

        .measurements-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .measurement-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .measurement-item {
            background: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .measurement-label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
        }

        .measurement-value {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin-top: 2px;
        }

        /* Challenge styles */
        .challenge-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .challenge-section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
        }

        .challenge-section:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .challenge-section.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .challenge-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .challenge-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 24px;
            color: white;
        }

        .challenge-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .challenge-description {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .quiz-question {
            margin-bottom: 15px;
        }

        .quiz-question h4 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .quiz-options {
            display: grid;
            gap: 8px;
        }

        .quiz-option {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .quiz-option:hover {
            border-color: #6366f1;
            background: #f8fafc;
        }

        .quiz-option.selected {
            border-color: #6366f1;
            background: #eff6ff;
        }

        .quiz-option.correct {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .quiz-option.incorrect {
            border-color: #ef4444;
            background: #fef2f2;
        }

        /* Fill in the blanks styles */
        .fill-blank-container {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .fill-blank-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #374151;
        }

        .fill-blank-input {
            display: inline-block;
            border: none;
            border-bottom: 2px solid #6366f1;
            background: transparent;
            padding: 2px 8px;
            margin: 0 4px;
            font-weight: 600;
            color: #1f2937;
            min-width: 80px;
            text-align: center;
        }

        .fill-blank-input:focus {
            outline: none;
            border-bottom-color: #8b5cf6;
            background: rgba(99, 102, 241, 0.1);
        }

        .fill-blank-input.correct {
            border-bottom-color: #10b981;
            background: #ecfdf5;
        }

        .fill-blank-input.incorrect {
            border-bottom-color: #ef4444;
            background: #fef2f2;
        }

        /* Matching styles */
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
            position: relative;
        }

        .matching-column {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
        }

        .matching-item {
            padding: 12px 16px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            user-select: none;
        }

        .matching-item:hover {
            border-color: #6366f1;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
        }

        .matching-item.selected {
            border-color: #6366f1;
            background: #eff6ff;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transform: translateX(5px);
        }

        .matching-item.matched {
            border-color: #6366f1;
            background: #eff6ff;
            cursor: default;
        }

        .matching-item.matched:hover {
            transform: none;
        }

        .matching-item.correct-match {
            border-color: #10b981;
            background: #ecfdf5;
            animation: correctMatch 0.5s ease-in-out;
        }

        .matching-item.incorrect-match {
            border-color: #ef4444;
            background: #fef2f2;
            animation: incorrectMatch 0.5s ease-in-out;
        }



        @keyframes correctMatch {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectMatch {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .matching-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: #6366f1;
            transition: background-color 0.3s ease;
            border-radius: 1px;
        }

        .connection-line.correct {
            background: #16a34a;
            box-shadow: 0 0 4px rgba(22, 163, 74, 0.3);
        }

        .connection-line.incorrect {
            background: #ef4444;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.3);
        }

        /* Challenge controls */
        .challenge-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .challenge-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .challenge-btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .challenge-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .challenge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .challenge-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Challenge feedback */
        .challenge-feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .challenge-feedback.success {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }

        .challenge-feedback.error {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            color: #991b1b;
        }

        /* Challenge progress */
        .challenge-progress {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .challenge-progress-bar .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            transition: width 0.3s ease;
        }

        .challenge-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #6366f1;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Enhanced challenge feedback and hints */
        .challenge-hint {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .challenge-hint.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .explanation-panel {
            background: #f0f9ff;
            border: 1px solid #7dd3fc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .explanation-panel.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .explanation-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 10px;
        }

        .explanation-title i {
            margin-right: 8px;
        }

        .explanation-content {
            color: #075985;
            line-height: 1.5;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tour styles */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .tour-overlay.active {
            opacity: 1;
            visibility: visible;
            pointer-events: none; /* Keep non-blocking to allow background interaction */
        }

        .tour-spotlight {
            position: absolute;
            border: 3px solid #6366f1;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.1);
            transition: all 0.5s ease;
            z-index: 1001;
            pointer-events: none;
        }

        .tour-popup {
            position: fixed;
            max-width: 380px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1002;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .tour-popup.active {
            transform: scale(1);
            opacity: 1;
        }

        .tour-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tour-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .tour-header span {
            color: #6b7280;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .tour-content {
            color: #374151;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .tour-exercise {
            background: #eff6ff;
            border: 1px solid #dbeafe;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .tour-exercise-label {
            color: #1d4ed8;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tour-exercise-task {
            color: #1e40af;
            font-size: 0.9rem;
            font-style: italic;
        }

        .tour-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .tour-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tour-btn-primary {
            background: #6366f1;
            color: white;
        }

        .tour-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        /* Mobile tour adjustments */
        @media (max-width: 768px) {
            .tour-popup {
                max-width: 90vw;
                margin: 10px;
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%) scale(0);
            }
            
            .tour-popup.active {
                transform: translate(-50%, -50%) scale(1);
            }
            
            .tour-spotlight {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.15);
            }
        }

        /* Quantum visualization specific */
        #vis-container {
            width: 800px;
            height: 600px;
            display: inline-block;
            vertical-align: bottom;
            position: relative;
            background: transparent;
            border-radius: 8px;
            max-width: 100%;
        }

        #ui-and-tutorial-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #ui-container {
            position: relative;
        }

        #ui-scale-target {
            transform-origin: center center;
        }

        /* Make draggers visible and functional */
        .h-draggers, .v-draggers {
            position: absolute;
            z-index: 10;
        }

        .dragger {
            position: absolute;
            z-index: 20;
        }

        .dragger .centerer {
            position: relative;
        }

        .dragger .grip {
            width: 20px;
            height: 20px;
            background: rgba(99, 102, 241, 0.8);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .dragger .touch_event_target,
        .dragger .click_event_target {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 40px;
            height: 40px;
            cursor: pointer;
        }

        .dragger .value_text {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            pointer-events: none;
        }

        /* Ensure the old options are hidden but functional */
        .options {
            display: none;
        }

        /* Ensure Three.js canvas works properly */
        #vis-container canvas {
            display: block !important;
            position: relative !important;
        }

        /* Fix any potential z-index issues */
        #vis-container {
            z-index: 1;
        }

        .h-draggers, .v-draggers {
            z-index: 10;
        }

        .dragger {
            z-index: 20;
        }

        .quantum-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .potential-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .potential-btn {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .potential-btn:hover {
            border-color: #6366f1;
            background: #f8fafc;
        }

        .potential-btn.active {
            border-color: #6366f1;
            background: #eff6ff;
            color: #6366f1;
        }

        .wave-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .wave-toggle {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .wave-toggle input {
            margin-right: 8px;
        }

        .wave-toggle label {
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Floating buttons */
        .floating-button {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 100;
        }

        .floating-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        }

        .floating-button.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            bottom: 30px;
            right: 30px;
        }

        .floating-button.tour {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            bottom: 100px;
            right: 30px;
        }

        /* Mobile-specific floating button adjustments */
        @media (max-width: 768px) {
            .floating-button {
                width: 50px;
                height: 50px;
                font-size: 16px;
                bottom: 20px;
                right: 20px;
            }
            
            .floating-button.tour {
                bottom: 80px;
            }
        }

        /* Floating panels */
        .floating-panel {
            position: fixed;
            top: 50%;
            right: -400px;
            transform: translateY(-50%);
            width: 350px;
            max-height: 80vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 200;
            overflow: hidden;
        }

        .floating-panel.active {
            right: 30px;
        }

        .floating-panel-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .floating-panel-close {
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .floating-panel-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .floating-panel-content {
            padding: 20px;
            max-height: calc(80vh - 80px);
            overflow-y: auto;
        }

        .panel-title {
            margin: 0;
            font-size: 1.2rem;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .controls-panel {
                order: -1;
            }
        }

        /* Enhanced mobile responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            
            .container {
                padding: 12px;
                border-radius: 12px;
            }
            
            .title {
                font-size: 1.4rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .experiment-tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .potential-selector {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .potential-btn {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            .control-group {
                margin-bottom: 15px;
            }
            
            .control-label {
                font-size: 0.85rem;
                margin-bottom: 6px;
            }
            
            .measurement-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .quantum-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 12px;
            }
            
            .challenge-container {
                padding: 16px;
            }
            
            .challenge-section {
                padding: 16px;
                margin-bottom: 20px;
            }
            
            .challenge-header {
                flex-direction: column;
                text-align: center;
                margin-bottom: 15px;
            }
            
            .challenge-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .challenge-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .challenge-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .visualization-area {
                min-height: 300px;
                padding: 12px;
            }
            
            #vis-container {
                width: 100%;
                height: 300px;
                max-width: 100%;
            }
        }

        /* Touch-friendly improvements */
        @media (max-width: 768px) and (pointer: coarse) {
            .btn, .challenge-btn, .potential-btn, .tab {
                min-height: 44px; /* Touch target size */
                padding: 12px 16px;
            }
            
            .quiz-option {
                padding: 16px;
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .matching-item {
                padding: 16px;
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .wave-toggle {
                min-height: 44px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
        </div>

        <div class="experiment-tabs">
            <button class="tab active" onclick="switchTab(this, 'wavefunction')">
                <i class="fas fa-wave-square"></i> Wavefunction Explorer
            </button>
            <button class="tab" onclick="switchTab(this, 'challenges')">
                <i class="fas fa-brain"></i> Quantum Challenges
            </button>
        </div>

        <!-- Wavefunction Explorer -->
        <div id="wavefunction" class="experiment-content active">
            <div class="main-content">
                <div class="visualization-area">
                    <div id="ui-and-tutorial-container" class="noselect">
                        <div id="ui-container">
                            <div id="ui-scale-target">
                                <div id="potential-dragging-container" class="h-draggers">
                                    <div id="potential_dragger" class="dragger">
                                        <div class="centerer">
                                            <div class="grip"></div>
                                            <div class="touch_event_target"></div>
                                            <div class="click_event_target"></div>
                                        </div>
                                    </div>
                                </div>
                                <div id="vis-container">
                                    <div id="draw-text" style="visibility: hidden">Draw</div>
                                </div>
                                <div id="energy-dragging-container" class="v-draggers">
                                    <div class="dragger" id="energy_dragger_prototype" style="display: none">
                                        <div class="centerer">
                                            <div class="grip"></div>
                                            <div class="value_text">12345</div>
                                            <div class="touch_event_target"></div>
                                            <div class="click_event_target"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden original options for functionality -->
                                <div class="options noselect" style="position: absolute; visibility: hidden;">
                                    <div class="menu-button-container">
                                        <button id="potential_chooser" class="menu-button">V</button>
                                    </div>
                                    <div class="option-item separator"></div>
                                    <div id="psi_container">
                                        <input type="checkbox" id="check_psi_hidden" name="psi" checked />
                                        <label for="check_psi_hidden">œà</label>
                                        <input type="checkbox" id="check_psiAbs_hidden" name="psiAbs" />
                                        <label for="check_psiAbs_hidden">|œà|¬≤</label>
                                    </div>
                                    <div id="phi-container">
                                        <input type="checkbox" id="check_phi_hidden" name="phi" />
                                        <label for="check_phi_hidden">œÜ</label>
                                        <input type="checkbox" id="check_phiAbs_hidden" name="phiAbs" />
                                        <label for="check_phiAbs_hidden">|œÜ|¬≤</label>
                                    </div>
                                    <div class="option-item separator"></div>
                                    <input type="checkbox" id="check_paused_hidden" name="paused" checked />
                                    <label for="check_paused_hidden">‚ñ∂</label>
                                    <div class="option-item spacer"></div>
                                    <div id="rotator" class="option-item noselect">
                                        <div id="rotator_knob"></div>
                                    </div>
                                    <div id="energy_buttons">
                                        <button class="square-button" onClick="Vis.addEnergySlider()">+</button>
                                        <button class="square-button" onClick="Vis.removeEnergySlider()">-</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="controls-panel">
                    <div class="control-group">
                        <label class="control-label">
                            <i class="fas fa-mountain"></i> Potential Type
                        </label>
                        <div class="potential-selector">
                            <button class="potential-btn active" onclick="loadPotential('SHO', this)">
                                <i class="fas fa-sine-wave"></i> Harmonic
                            </button>
                            <button class="potential-btn" onclick="loadPotential('ISW', this)">
                                <i class="fas fa-square"></i> Infinite Well
                            </button>
                            <button class="potential-btn" onclick="loadPotential('FSW', this)">
                                <i class="fas fa-square-full"></i> Finite Well
                            </button>
                            <button class="potential-btn" onclick="loadPotential('2SW', this)">
                                <i class="fas fa-equals"></i> Double Well
                            </button>
                            <button class="potential-btn" onclick="loadPotential('stepped', this)">
                                <i class="fas fa-stairs"></i> Stepped
                            </button>
                            <button class="potential-btn" onclick="loadPotential('random', this)">
                                <i class="fas fa-dice"></i> Random
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            <i class="fas fa-eye"></i> Visualization Options
                        </label>
                        <div class="wave-controls">
                            <div class="wave-toggle">
                                <input type="checkbox" id="check_psi" checked>
                                <label for="check_psi">Real œà</label>
                            </div>
                            <div class="wave-toggle">
                                <input type="checkbox" id="check_psiAbs">
                                <label for="check_psiAbs">|œà|¬≤</label>
                            </div>
                            <div class="wave-toggle">
                                <input type="checkbox" id="check_phi">
                                <label for="check_phi">œÜ(k)</label>
                            </div>
                            <div class="wave-toggle">
                                <input type="checkbox" id="check_phiAbs">
                                <label for="check_phiAbs">|œÜ(k)|¬≤</label>
                            </div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            <i class="fas fa-bolt"></i> Energy Levels
                        </label>
                        <div class="quantum-controls">
                            <button class="btn btn-primary" onclick="addEnergyLevel()">
                                <i class="fas fa-plus"></i> Add Level
                            </button>
                            <button class="btn btn-secondary" onclick="removeEnergyLevel()">
                                <i class="fas fa-minus"></i> Remove Level
                            </button>
                        </div>
                    </div>

                    <div class="measurements-section">
                        <h3><i class="fas fa-chart-line"></i> Measurements</h3>
                        <div class="measurement-grid">
                            <div class="measurement-item">
                                <div class="measurement-label">Energy (eV)</div>
                                <div class="measurement-value" id="energy-value">0.00</div>
                            </div>
                            <div class="measurement-item">
                                <div class="measurement-label">Momentum</div>
                                <div class="measurement-value" id="momentum-value">0.00</div>
                            </div>
                            <div class="measurement-item">
                                <div class="measurement-label">Position</div>
                                <div class="measurement-value" id="position-value">0.00</div>
                            </div>
                            <div class="measurement-item">
                                <div class="measurement-label">Uncertainty</div>
                                <div class="measurement-value" id="uncertainty-value">0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Challenges -->
        <div id="challenges" class="experiment-content">
            <div class="challenge-container">
                <!-- Challenge Progress Overview -->
                <div class="challenge-progress">
                    <h2 style="margin-bottom: 20px; color: #1f2937;">üß† Quantum Mechanics Challenge Hub</h2>
                    <div class="challenge-progress-bar">
                        <div class="progress-fill" id="overallProgress" style="width: 0%;"></div>
                    </div>
                    <p style="color: #6b7280; margin-bottom: 20px;">Test your understanding across multiple challenge types</p>
                    <div class="challenge-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalScore">0</div>
                            <div class="stat-label">Total Score</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="challengesCompleted">0/6</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="accuracy">0%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                    </div>
                </div>

                <!-- Rapid Fire MCQ Challenge -->
                <div class="challenge-section" id="rapidFireChallenge">
                    <div class="challenge-header">
                        <div class="challenge-icon">‚ö°</div>
                        <div>
                            <h3 class="challenge-title">Rapid Fire MCQ</h3>
                            <p class="challenge-description">Quick multiple choice questions on quantum fundamentals</p>
                        </div>
                    </div>
                    <div id="rapidFireContent">
                        <!-- Questions will be generated dynamically -->
                    </div>
                    <div class="challenge-feedback" id="rapidFireFeedback"></div>
                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkRapidFireAnswers()">Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showRapidFireHints()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="generateNewRapidFireQuestions()">üîÑ New Questions</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge('rapidFire')">üîÑ Reset</button>
                    </div>
                </div>

                <!-- Advanced Concepts Challenge -->
                <div class="challenge-section" id="advancedConceptsChallenge">
                    <div class="challenge-header">
                        <div class="challenge-icon">üéì</div>
                        <div>
                            <h3 class="challenge-title">Advanced Concepts</h3>
                            <p class="challenge-description">Deep dive into quantum mechanical principles</p>
                        </div>
                    </div>
                    <div id="advancedConceptsContent">
                        <!-- Advanced questions will be generated dynamically -->
                    </div>
                    <div class="challenge-feedback" id="advancedConceptsFeedback"></div>
                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkAdvancedAnswers()">Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showAdvancedHints()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="generateNewAdvancedQuestions()">üîÑ New Questions</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge('advanced')">üîÑ Reset</button>
                    </div>
                </div>

                <!-- Fill in the Blanks Challenge -->
                <div class="challenge-section" id="fillBlanksChallenge">
                    <div class="challenge-header">
                        <div class="challenge-icon">üìù</div>
                        <div>
                            <h3 class="challenge-title">Fill in the Blanks</h3>
                            <p class="challenge-description">Complete quantum mechanical equations and statements</p>
                        </div>
                    </div>
                    <div class="fill-blank-container">
                        <div class="fill-blank-text">
                            The Schr√∂dinger equation in one dimension is: 
                            <input type="text" class="fill-blank-input" id="blank1" placeholder="?"> œà = E œà, 
                            where the energy eigenvalues for a particle in an infinite well are E_n = 
                            <input type="text" class="fill-blank-input" id="blank2" placeholder="?"> and 
                            the uncertainty principle states that Œîx¬∑Œîp ‚â• 
                            <input type="text" class="fill-blank-input" id="blank3" placeholder="?">.
                        </div>
                        <div class="fill-blank-text" style="margin-top: 20px;">
                            The probability density is given by |œà|¬≤ and must be 
                            <input type="text" class="fill-blank-input" id="blank4" placeholder="?"> over all space. 
                            Quantum tunneling occurs when a particle's energy is 
                            <input type="text" class="fill-blank-input" id="blank5" placeholder="?"> the potential barrier height.
                        </div>
                    </div>
                    <div class="challenge-feedback" id="fillBlanksFeedback"></div>
                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkFillBlanks()">Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showFillBlanksHint()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge('fillBlanks')">üîÑ Reset</button>
                    </div>
                </div>

                <!-- Calculation Challenge -->
                <div class="challenge-section" id="calculationChallenge">
                    <div class="challenge-header">
                        <div class="challenge-icon">üßÆ</div>
                        <div>
                            <h3 class="challenge-title">Quantum Calculations</h3>
                            <p class="challenge-description">Solve numerical problems in quantum mechanics</p>
                        </div>
                    </div>
                    <div class="quiz-question">
                        <h4>Problem 1: Energy Levels</h4>
                        <p>Calculate the ground state energy (n=1) of an electron in a 1D infinite potential well of width L = 1 nm. 
                        Use: h = 6.626 √ó 10‚Åª¬≥‚Å¥ J¬∑s, m_e = 9.109 √ó 10‚Åª¬≥¬π kg</p>
                        <input type="number" class="control-input" id="calc1" placeholder="Energy in eV" step="0.01">
                        <div class="challenge-hint" id="calc1Hint">
                            üí° Hint: E_n = n¬≤œÄ¬≤‚Ñè¬≤/(2mL¬≤), convert to eV using 1 eV = 1.602 √ó 10‚Åª¬π‚Åπ J
                        </div>
                    </div>
                    <div class="quiz-question">
                        <h4>Problem 2: de Broglie Wavelength</h4>
                        <p>What is the de Broglie wavelength of an electron moving at 10% the speed of light?</p>
                        <input type="number" class="control-input" id="calc2" placeholder="Wavelength in pm" step="0.1">
                        <div class="challenge-hint" id="calc2Hint">
                            üí° Hint: Œª = h/p = h/(mv), where v = 0.1c and c = 3 √ó 10‚Å∏ m/s
                        </div>
                    </div>
                    <div class="challenge-feedback" id="calculationFeedback"></div>
                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkCalculations()">Check Calculations</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showCalculationHint()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge('calculation')">üîÑ Reset</button>
                    </div>
                </div>

                <!-- Matching Challenge -->
                <div class="challenge-section" id="matchingChallenge">
                    <div class="challenge-header">
                        <div class="challenge-icon">üîó</div>
                        <div>
                            <h3 class="challenge-title">Match the Following</h3>
                            <p class="challenge-description">Connect quantum concepts with their descriptions</p>
                        </div>
                    </div>
                    <div class="matching-container" id="matchingContainer">
                        <div class="matching-connections" id="matchingConnections"></div>
                        <div class="matching-column">
                            <h4 style="text-align: center; margin-bottom: 15px; color: #374151;">Concepts</h4>
                            <div class="matching-item" data-concept="wavefunction" onclick="selectMatchingItem(this)">
                                Wave Function œà(x,t)
                            </div>
                            <div class="matching-item" data-concept="uncertainty" onclick="selectMatchingItem(this)">
                                Heisenberg Uncertainty Principle
                            </div>
                            <div class="matching-item" data-concept="tunneling" onclick="selectMatchingItem(this)">
                                Quantum Tunneling
                            </div>
                            <div class="matching-item" data-concept="quantization" onclick="selectMatchingItem(this)">
                                Energy Quantization
                            </div>
                            <div class="matching-item" data-concept="superposition" onclick="selectMatchingItem(this)">
                                Quantum Superposition
                            </div>
                        </div>
                        <div class="matching-column">
                            <h4 style="text-align: center; margin-bottom: 15px; color: #374151;">Descriptions</h4>
                            <div class="matching-item" data-description="wavefunction" onclick="selectMatchingItem(this)">
                                Probability amplitude describing quantum state
                            </div>
                            <div class="matching-item" data-description="uncertainty" onclick="selectMatchingItem(this)">
                                Œîx¬∑Œîp ‚â• ‚Ñè/2 fundamental limit
                            </div>
                            <div class="matching-item" data-description="tunneling" onclick="selectMatchingItem(this)">
                                Particle penetration through potential barriers
                            </div>
                            <div class="matching-item" data-description="quantization" onclick="selectMatchingItem(this)">
                                Discrete allowed energy levels in bound systems
                            </div>
                            <div class="matching-item" data-description="superposition" onclick="selectMatchingItem(this)">
                                Linear combination of quantum states
                            </div>
                        </div>
                    </div>
                    <div class="challenge-feedback" id="matchingFeedback"></div>
                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkMatching()">Check Matches</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showMatchingHints()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge('matching')">üîÑ Reset</button>
                    </div>
                </div>

                <!-- Conceptual Understanding Challenge -->
                <div class="challenge-section" id="conceptualChallenge">
                    <div class="challenge-header">
                        <div class="challenge-icon">üí≠</div>
                        <div>
                            <h3 class="challenge-title">Conceptual Understanding</h3>
                            <p class="challenge-description">Deep conceptual questions about quantum behavior</p>
                        </div>
                    </div>
                    <div class="quiz-question">
                        <h4>Scenario Analysis: Double-Slit Experiment</h4>
                        <p>In the quantum double-slit experiment, what happens to the interference pattern when we try to determine which slit the particle goes through?</p>
                        <div class="quiz-options">
                            <div class="quiz-option" onclick="selectConceptualAnswer(1, 1, this)">
                                The interference pattern becomes more pronounced
                            </div>
                            <div class="quiz-option" onclick="selectConceptualAnswer(1, 2, this)">
                                The interference pattern disappears
                            </div>
                            <div class="quiz-option" onclick="selectConceptualAnswer(1, 3, this)">
                                The pattern shifts but remains visible
                            </div>
                            <div class="quiz-option" onclick="selectConceptualAnswer(1, 4, this)">
                                Nothing changes in the pattern
                            </div>
                        </div>
                    </div>
                    <div class="quiz-question">
                        <h4>Wave-Particle Duality</h4>
                        <p>Why can't classical physics explain the photoelectric effect?</p>
                        <div class="quiz-options">
                            <div class="quiz-option" onclick="selectConceptualAnswer(2, 1, this)">
                                Classical waves should eject electrons regardless of frequency
                            </div>
                            <div class="quiz-option" onclick="selectConceptualAnswer(2, 2, this)">
                                The energy depends on intensity, not frequency in classical theory
                            </div>
                            <div class="quiz-option" onclick="selectConceptualAnswer(2, 3, this)">
                                Classical theory predicts no electron ejection at any frequency
                            </div>
                            <div class="quiz-option" onclick="selectConceptualAnswer(2, 4, this)">
                                Both A and B are correct
                            </div>
                        </div>
                    </div>
                    <div class="challenge-feedback" id="conceptualFeedback"></div>
                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="checkConceptualAnswers()">Check Understanding</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="showConceptualHints()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge('conceptual')">üîÑ Reset</button>
                    </div>
                </div>

                <!-- Reset All Button -->
                <div style="text-align: center; margin-top: 40px;">
                    <button class="challenge-btn challenge-btn-secondary" onclick="resetAllChallenges()" style="font-size: 16px; padding: 15px 30px;">
                        üîÑ Reset All Challenges
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <div class="floating-button tour" onclick="handleTourButtonClick()">
        <i class="fas fa-route"></i>
    </div>

    <div class="floating-button primary" onclick="toggleHelp()">
        <i class="fas fa-question"></i>
    </div>

    <!-- Tour Elements -->
    <div class="tour-overlay" id="tourOverlay">
        <div class="tour-spotlight" id="tourSpotlight"></div>
    </div>

    <div class="tour-popup" id="tourPopup">
        <div class="tour-header">
            <h3 id="tourTitle">Quantum Tour</h3>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="tourStepCounter">Step 1 of 7</span>
                <button class="tour-btn tour-btn-secondary" onclick="endTour()" style="padding: 4px 8px; font-size: 12px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="tour-content" id="tourContent">
            Welcome to the Quantum Wavefunction Lab!
        </div>
        <div class="tour-controls">
            <button class="tour-btn tour-btn-secondary" onclick="prevTourStep()" id="tourPrevBtn">Previous</button>
            <button class="tour-btn tour-btn-primary" onclick="setupCurrentExercise()" id="tourTryBtn" style="display: none;">
                <i class="fas fa-flask"></i> Try It
            </button>
            <button class="tour-btn tour-btn-primary" onclick="nextTourStep()" id="tourNextBtn">Next</button>
        </div>
    </div>

    <!-- Help Panel -->
    <div class="floating-panel" id="helpPanel">
        <div class="floating-panel-header">
            <h3 class="panel-title">Quick Help</h3>
            <div class="floating-panel-close" onclick="toggleHelp()">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="floating-panel-content">
            <h4>Controls:</h4>
            <ul>
                <li>Select different potential wells</li>
                <li>Toggle visualization options</li>
                <li>Add/remove energy levels</li>
                <li>Play/pause animation</li>
            </ul>
            <h4>Concepts:</h4>
            <ul>
                <li>Wavefunction œà(x,t)</li>
                <li>Probability density |œà|¬≤</li>
                <li>Energy quantization</li>
                <li>Uncertainty principle</li>
            </ul>
        </div>
    </div>
    <script type="text/javascript" src="../three.min.js" onerror="console.error('Failed to load THREE.js')"></script>
    <script type="text/javascript" src="../js/visualize.min.js" onerror="console.error('Failed to load visualize.min.js')"></script>
    
    <!-- Safari compatibility script -->
    <script>
        // Safari-specific fixes
        if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
            // Ensure WebGL context is available
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) {
                document.addEventListener('DOMContentLoaded', function() {
                    const visContainer = document.getElementById('vis-container');
                    if (visContainer) {
                        visContainer.innerHTML = '<div style="color: red; padding: 20px; text-align: center;">WebGL is required but not supported in your Safari version. Please try Chrome or Firefox, or enable WebGL in Safari preferences.</div>';
                    }
                });
            }
        }
    </script>
    
    <!-- Mobile Detection Script -->
    <script>
        // Mobile Detection and Overlay Script for Quantum Lab
        // This script detects mobile devices and shows a desktop optimization warning

        class MobileDetection {
          constructor() {
            this.isMobile = this.detectMobile();
            this.overlayShown = false;
            this.userContinuedOnMobile = false;
            this.init();
          }

          detectMobile() {
            // Check for mobile user agents
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            
            // Mobile device patterns
            const mobilePatterns = [
              /Android/i,
              /webOS/i,
              /iPhone/i,
              /iPad/i,
              /iPod/i,
              /BlackBerry/i,
              /Windows Phone/i,
              /Opera Mini/i,
              /IEMobile/i,
              /Mobile/i
            ];

            // Check screen size (additional check for small screens)
            const isSmallScreen = window.innerWidth <= 768 || window.innerHeight <= 600;
            
            // Check touch capability
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            // Return true if any mobile pattern matches OR if it's a small touch screen
            return mobilePatterns.some(pattern => pattern.test(userAgent)) || 
                   (isSmallScreen && isTouchDevice);
          }

          init() {
            if (this.isMobile && !this.overlayShown) {
              // Wait for DOM to be ready
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => this.showOverlay());
              } else {
                this.showOverlay();
              }
            }
          }

          showOverlay() {
            if (this.overlayShown) return;
            
            this.overlayShown = true;

            // Create overlay HTML
            const overlay = document.createElement('div');
            overlay.id = 'mobile-warning-overlay';
            overlay.innerHTML = `
              <div class="mobile-overlay-backdrop">
                <div class="mobile-overlay-content">
                  <div class="mobile-overlay-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L2 7V10C2 16 6 20.5 12 22C18 20.5 22 16 22 10V7L12 2Z" stroke="#f59e0b" stroke-width="2" fill="#fef3c7"/>
                      <path d="M12 8V13M12 16H12.01" stroke="#f59e0b" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <h2 class="mobile-overlay-title">Desktop Experience Recommended</h2>
                  <p class="mobile-overlay-description">
                    This quantum mechanics experiment is optimized for desktop computers with larger screens and precise mouse interaction. 
                    While you can continue on mobile, you may experience:
                  </p>
                  <ul class="mobile-overlay-list">
                    <li>‚Ä¢ Difficulty manipulating quantum wavefunction controls</li>
                    <li>‚Ä¢ Limited screen space for complex visualizations</li>
                    <li>‚Ä¢ Reduced functionality for energy level adjustments</li>
                    <li>‚Ä¢ Guided tour will be disabled for better mobile experience</li>
                  </ul>
                  <div class="mobile-overlay-actions">
                    <button class="mobile-overlay-btn mobile-overlay-btn-primary" onclick="mobileDetection.continueAnyway()">
                      Continue Anyway
                    </button>
                    <button class="mobile-overlay-btn mobile-overlay-btn-secondary" onclick="mobileDetection.goBack()">
                      Use Desktop Instead
                    </button>
                  </div>
                  <p class="mobile-overlay-footer">
                    For the best quantum learning experience, please access this on a desktop or laptop computer.
                  </p>
                </div>
              </div>
            `;

            // Add overlay styles
            const styles = `
              <style>
                .mobile-overlay-backdrop {
                  position: fixed;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: rgba(0, 0, 0, 0.8);
                  backdrop-filter: blur(4px);
                  z-index: 10000;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  padding: 20px;
                  animation: fadeIn 0.3s ease-out;
                }

                .mobile-overlay-content {
                  background: white;
                  border-radius: 16px;
                  padding: 24px;
                  max-width: 400px;
                  width: 100%;
                  max-height: 90vh;
                  overflow-y: auto;
                  text-align: center;
                  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                  animation: slideUp 0.3s ease-out;
                }

                .mobile-overlay-icon {
                  margin: 0 auto 16px;
                  width: 48px;
                  height: 48px;
                }

                .mobile-overlay-title {
                  font-size: 20px;
                  font-weight: 600;
                  color: #1f2937;
                  margin-bottom: 12px;
                  line-height: 1.3;
                }

                .mobile-overlay-description {
                  font-size: 14px;
                  color: #6b7280;
                  margin-bottom: 16px;
                  line-height: 1.5;
                  text-align: left;
                }

                .mobile-overlay-list {
                  text-align: left;
                  font-size: 14px;
                  color: #6b7280;
                  margin-bottom: 20px;
                  padding-left: 0;
                  list-style: none;
                }

                .mobile-overlay-list li {
                  margin-bottom: 6px;
                  line-height: 1.4;
                }

                .mobile-overlay-actions {
                  display: flex;
                  flex-direction: column;
                  gap: 12px;
                  margin-bottom: 16px;
                }

                .mobile-overlay-btn {
                  padding: 12px 20px;
                  border-radius: 8px;
                  font-size: 14px;
                  font-weight: 500;
                  border: none;
                  cursor: pointer;
                  transition: all 0.2s ease;
                  width: 100%;
                }

                .mobile-overlay-btn-primary {
                  background: #3b82f6;
                  color: white;
                }

                .mobile-overlay-btn-primary:hover {
                  background: #2563eb;
                  transform: translateY(-1px);
                }

                .mobile-overlay-btn-secondary {
                  background: #f3f4f6;
                  color: #374151;
                  border: 1px solid #d1d5db;
                }

                .mobile-overlay-btn-secondary:hover {
                  background: #e5e7eb;
                  transform: translateY(-1px);
                }

                .mobile-overlay-footer {
                  font-size: 12px;
                  color: #9ca3af;
                  line-height: 1.4;
                }

                @keyframes fadeIn {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }

                @keyframes slideUp {
                  from { 
                    opacity: 0;
                    transform: translateY(20px) scale(0.95);
                  }
                  to { 
                    opacity: 1;
                    transform: translateY(0) scale(1);
                  }
                }

                @keyframes fadeOut {
                  from { opacity: 1; }
                  to { opacity: 0; }
                }

                @media (min-width: 480px) {
                  .mobile-overlay-actions {
                    flex-direction: row;
                  }
                  
                  .mobile-overlay-btn {
                    width: auto;
                    flex: 1;
                  }
                }
              </style>
            `;

            // Add styles to head
            document.head.insertAdjacentHTML('beforeend', styles);
            
            // Add overlay to body
            document.body.appendChild(overlay);
            
            // Prevent body scrolling
            document.body.style.overflow = 'hidden';
          }

          continueAnyway() {
            this.userContinuedOnMobile = true;
            this.hideOverlay();
            
            // Disable guided tour for mobile users
            if (typeof window !== 'undefined') {
              window.DISABLE_GUIDED_TOUR = true;
            }
            
            // Show a brief notification that tour is disabled
            setTimeout(() => {
              const notification = document.createElement('div');
              notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #3b82f6;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideInRight 0.3s ease-out;
              `;
              notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span>üì±</span>
                  <span>Mobile mode: Guided tour disabled</span>
                </div>
              `;
              
              document.body.appendChild(notification);
              
              // Add slide in animation
              const slideInStyles = `
                <style>
                  @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                  }
                </style>
              `;
              document.head.insertAdjacentHTML('beforeend', slideInStyles);
              
              // Remove notification after 4 seconds
              setTimeout(() => {
                if (notification.parentNode) {
                  notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
                  setTimeout(() => {
                    if (notification.parentNode) {
                      notification.parentNode.removeChild(notification);
                    }
                  }, 300);
                }
              }, 4000);
              
              // Add slide out animation
              const slideOutStyles = `
                <style>
                  @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                  }
                </style>
              `;
              document.head.insertAdjacentHTML('beforeend', slideOutStyles);
            }, 500);
          }

          goBack() {
            // Try to go back in history, or redirect to a homepage if available
            if (window.history.length > 1) {
              window.history.back();
            } else {
              // You can customize this to redirect to your main page
              alert('Please bookmark this page and open it on a desktop computer for the best quantum physics learning experience.');
            }
          }

          hideOverlay() {
            const overlay = document.getElementById('mobile-warning-overlay');
            if (overlay) {
              overlay.style.animation = 'fadeOut 0.3s ease-out forwards';
              setTimeout(() => {
                overlay.remove();
                document.body.style.overflow = '';
              }, 300);
            }
          }

          // Method to check if user continued on mobile (for use by other scripts)
          isContinuingOnMobile() {
            return this.isMobile && this.userContinuedOnMobile;
          }
        }

        // Initialize mobile detection
        const mobileDetection = new MobileDetection();

        // Export for use in other scripts if needed
        if (typeof module !== 'undefined' && module.exports) {
          module.exports = MobileDetection;
        }
    </script>
    
    <script>
        // Global variables
        let currentTab = 'wavefunction';
        let helpPanelVisible = false;
        let tourActive = false;
        let currentTourStep = 0;
        let tourScore = 0;
        let Vis;

        // Initialize the visualizer when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeQuantumLab();
            
            // Update tour button icon for mobile users
            updateTourButtonForMobile();
        });

        function updateTourButtonForMobile() {
            if (mobileDetection && mobileDetection.isMobile) {
                // Wait a bit for mobile detection to complete
                setTimeout(() => {
                    const tourButton = document.querySelector('.floating-button.tour i');
                    if (tourButton && mobileDetection.isContinuingOnMobile()) {
                        tourButton.className = 'fas fa-info-circle'; // Change to info icon for mobile help
                        tourButton.parentElement.title = 'Mobile Quick Guide';
                    } else if (tourButton) {
                        tourButton.parentElement.title = 'Start Guided Tour';
                    }
                }, 1000);
            }
        }

        function initializeQuantumLab() {
            // Setup the visualizer
            setupVisualizer();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize challenges
            initializeChallenges();
            
            // Initialize measurements display
            updateMeasurements('0.5 eV', '‚àû', '0.0 nm', '0.1');
            
            // Only start guided tour if not disabled and not on mobile
            const shouldStartTour = !window.DISABLE_GUIDED_TOUR && 
                                  !(mobileDetection && mobileDetection.isContinuingOnMobile());
            
            if (shouldStartTour) {
                // Auto-start the guided tour after 1 second delay
                setTimeout(startGuidedTour, 1000);
            } else {
                console.log('Guided tour disabled - mobile device detected or tour disabled');
            }
        }

        function setupVisualizer() {
            // Add a small delay to ensure all scripts are loaded
            setTimeout(() => {
                if (typeof visualizing !== 'undefined') {
                    const vis_container = document.getElementById("vis-container");
                    const potential_container = document.getElementById("potential_dragger");
                    const energy_container = document.getElementById("energy-dragging-container");
                    const energy_dragger_prototype = document.getElementById("energy_dragger_prototype");
                    
                    try {
                        Vis = new visualizing.Visualizer(vis_container, potential_container, energy_container, energy_dragger_prototype);
                        Vis.loadSHO();
                        Vis.addEnergySlider();

                        // Setup rotator if ui is available
                        if (typeof ui !== 'undefined') {
                            const rotatorElement = document.getElementById("rotator");
                            if (rotatorElement) {
                                ui.setupRotatorKnob(rotatorElement,
                                    function(rads) { 
                                        if (Vis) Vis.setRotation(rads);
                                    }
                                );
                            }
                            
                            window.addEventListener("resize", ui.resizeToFitWindowHeight);
                            window.addEventListener("orientationchange", ui.resizeToFitWindowHeight);
                            ui.resizeToFitWindowHeight();
                        }

                        // Update measurements display
                        updateMeasurements('0.5 eV', '‚àû', '0.0 nm', '0.1');
                        
                    } catch (error) {
                        console.error('Error initializing visualizer:', error);
                    }
                } else {
                    console.error('Visualizing module not loaded');
                }
            }, 100);
        }

        function setupEventListeners() {
            // Wave function toggles - sync visible controls with hidden ones
            document.getElementById('check_psi').addEventListener('change', function() {
                const hiddenCheckbox = document.getElementById('check_psi_hidden');
                hiddenCheckbox.checked = this.checked;
                if (Vis) Vis.setShowPsi(this.checked);
            });

            document.getElementById('check_psiAbs').addEventListener('change', function() {
                const hiddenCheckbox = document.getElementById('check_psiAbs_hidden');
                hiddenCheckbox.checked = this.checked;
                if (Vis) Vis.setShowPsiAbs(this.checked);
            });

            document.getElementById('check_phi').addEventListener('change', function() {
                const hiddenCheckbox = document.getElementById('check_phi_hidden');
                hiddenCheckbox.checked = this.checked;
                if (Vis) Vis.setShowPhi(this.checked);
            });

            document.getElementById('check_phiAbs').addEventListener('change', function() {
                const hiddenCheckbox = document.getElementById('check_phiAbs_hidden');
                hiddenCheckbox.checked = this.checked;
                if (Vis) Vis.setShowPhiAbs(this.checked);
            });
        }

        // Tab switching functionality
        function switchTab(tabButton, tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.experiment-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            tabButton.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
        }

        // Potential loading functions
        function loadPotential(type, button) {
            // Remove active class from all potential buttons
            document.querySelectorAll('.potential-btn').forEach(btn => btn.classList.remove('active'));
            
            // Only add active class if button exists
            if (button) {
                button.classList.add('active');
            }

            if (!Vis) {
                console.warn('Visualizer not initialized, cannot load potential:', type);
                return;
            }

            switch(type) {
                case 'SHO':
                    Vis.loadSHO();
                    updateMeasurements('0.5 eV', '‚àû', '0.0 nm', '0.1');
                    break;
                case 'ISW':
                    Vis.loadISW();
                    updateMeasurements('1.2 eV', '0', '0.0 nm', '0.05');
                    break;
                case 'FSW':
                    Vis.loadFSW();
                    updateMeasurements('0.8 eV', '2.1 ƒß/nm', '0.0 nm', '0.08');
                    break;
                case '2SW':
                    Vis.load2SW();
                    updateMeasurements('0.6 eV', '1.8 ƒß/nm', '0.0 nm', '0.12');
                    break;
                case 'stepped':
                    Vis.loadSteppedSW();
                    updateMeasurements('0.9 eV', '1.5 ƒß/nm', '0.0 nm', '0.09');
                    break;
                case 'random':
                    Vis.loadRandomPotential();
                    updateMeasurements('? eV', '?', '?', '?');
                    break;
            }
        }

        function updateMeasurements(energy, momentum, position, uncertainty) {
            console.log('Updating measurements:', { energy, momentum, position, uncertainty });
            
            const energyEl = document.getElementById('energy-value');
            const momentumEl = document.getElementById('momentum-value');
            const positionEl = document.getElementById('position-value');
            const uncertaintyEl = document.getElementById('uncertainty-value');
            
            if (energyEl) energyEl.textContent = energy || '0.00';
            if (momentumEl) momentumEl.textContent = momentum || '0.00';
            if (positionEl) positionEl.textContent = position || '0.00';
            if (uncertaintyEl) uncertaintyEl.textContent = uncertainty || '0.00';
        }

        // Energy level controls
        function addEnergyLevel() {
            if (Vis) Vis.addEnergySlider();
        }

        function removeEnergyLevel() {
            if (Vis) Vis.removeEnergySlider();
        }

        // Challenge system
        // Challenge system variables
        let challengeAnswers = {
            rapidFire: {},
            advanced: {},
            fillBlanks: {},
            calculation: {},
            matching: {},
            conceptual: {}
        };

        let challengeStates = {
            rapidFire: false,
            advanced: false,
            fillBlanks: false,
            calculation: false,
            matching: false,
            conceptual: false
        };

        let selectedMatchingItems = [];
        let matchingPairs = {};
        let totalChallenges = 6;
        let totalScore = 0;

        // Question banks
        const rapidFireQuestionBank = [
            {
                question: "What does the wavefunction œà(x,t) represent?",
                options: [
                    "The probability of finding a particle at position x",
                    "The amplitude whose square gives probability density",
                    "The energy of the quantum system",
                    "The momentum of the particle"
                ],
                correct: 1,
                explanation: "The wavefunction is a probability amplitude. |œà|¬≤ gives the actual probability density."
            },
            {
                question: "What is the ground state energy of a particle in an infinite square well?",
                options: [
                    "Zero",
                    "œÄ¬≤‚Ñè¬≤/(2mL¬≤)",
                    "‚Ñèœâ/2",
                    "kT"
                ],
                correct: 1,
                explanation: "For n=1 (ground state), E‚ÇÅ = œÄ¬≤‚Ñè¬≤/(2mL¬≤) due to boundary conditions."
            },
            {
                question: "The Heisenberg uncertainty principle states:",
                options: [
                    "ŒîE¬∑Œît ‚â• ‚Ñè",
                    "Œîx¬∑Œîp ‚â• ‚Ñè/2",
                    "Œîx¬∑Œîp ‚â• ‚Ñè",
                    "ŒîE¬∑Œît ‚â• ‚Ñè/2"
                ],
                correct: 1,
                explanation: "The fundamental form is Œîx¬∑Œîp ‚â• ‚Ñè/2, expressing the trade-off between position and momentum precision."
            },
            {
                question: "What happens to the wavefunction when it reaches a potential barrier?",
                options: [
                    "It always reflects completely",
                    "It always transmits completely",
                    "It partially reflects and partially transmits",
                    "It disappears"
                ],
                correct: 2,
                explanation: "At any potential discontinuity, the wavefunction exhibits both reflection and transmission."
            },
            {
                question: "The normalized wavefunction must satisfy:",
                options: [
                    "‚à´|œà|¬≤dx = 0",
                    "‚à´|œà|¬≤dx = 1",
                    "‚à´|œà|¬≤dx = ‚àû",
                    "‚à´œà dx = 1"
                ],
                correct: 1,
                explanation: "Normalization requires that the total probability of finding the particle anywhere is 1."
            },
            {
                question: "In the harmonic oscillator, energy levels are:",
                options: [
                    "Continuously distributed",
                    "Proportional to n",
                    "Proportional to n¬≤",
                    "Equally spaced"
                ],
                correct: 3,
                explanation: "Harmonic oscillator energy levels are En = ‚Ñèœâ(n + 1/2), equally spaced by ‚Ñèœâ."
            },
            {
                question: "The de Broglie wavelength is given by:",
                options: [
                    "Œª = h/p",
                    "Œª = p/h",
                    "Œª = E/h",
                    "Œª = h/E"
                ],
                correct: 0,
                explanation: "de Broglie's hypothesis: Œª = h/p, relating particle momentum to wavelength."
            },
            {
                question: "Which statement about quantum superposition is correct?",
                options: [
                    "A particle can only be in one state at a time",
                    "A particle can be in multiple states simultaneously",
                    "Superposition only applies to photons",
                    "Superposition violates energy conservation"
                ],
                correct: 1,
                explanation: "Quantum superposition allows particles to exist in combinations of multiple states."
            },
            {
                question: "The commutator [xÃÇ, pÃÇ] equals:",
                options: [
                    "0",
                    "i‚Ñè",
                    "-i‚Ñè",
                    "‚Ñè"
                ],
                correct: 1,
                explanation: "The canonical commutation relation [xÃÇ, pÃÇ] = i‚Ñè is fundamental to quantum mechanics."
            },
            {
                question: "What determines the width of a wavepacket?",
                options: [
                    "The particle's mass",
                    "The spread in momentum",
                    "The potential energy",
                    "The total energy"
                ],
                correct: 1,
                explanation: "By the uncertainty principle, a narrow momentum distribution leads to a wide position distribution."
            }
        ];

        const advancedQuestionBank = [
            {
                question: "In quantum tunneling, the transmission coefficient depends on:",
                options: [
                    "Only the barrier height",
                    "Only the barrier width",
                    "Both barrier height and width exponentially",
                    "The particle's mass linearly"
                ],
                correct: 2,
                explanation: "T ‚àù exp(-2Œ∫a) where Œ∫ depends on barrier height and a is the width."
            },
            {
                question: "The time evolution operator in quantum mechanics is:",
                options: [
                    "exp(-iHt/‚Ñè)",
                    "exp(-iEt/‚Ñè)",
                    "exp(iHt/‚Ñè)",
                    "exp(-Ht/‚Ñè)"
                ],
                correct: 0,
                explanation: "U(t) = exp(-iHt/‚Ñè) generates time evolution for any quantum state."
            },
            {
                question: "The WKB approximation is valid when:",
                options: [
                    "The potential varies slowly",
                    "The potential varies rapidly",
                    "The particle has high energy",
                    "The particle has low energy"
                ],
                correct: 0,
                explanation: "WKB works when the potential changes slowly compared to the de Broglie wavelength."
            },
            {
                question: "In the adiabatic approximation, what remains constant?",
                options: [
                    "The energy eigenvalues",
                    "The quantum numbers",
                    "The wavefunction",
                    "The Hamiltonian"
                ],
                correct: 1,
                explanation: "Adiabatic theorem: slowly varying Hamiltonians preserve quantum numbers."
            },
            {
                question: "The Berry phase arises from:",
                options: [
                    "Time evolution",
                    "Spatial translation",
                    "Adiabatic parameter variation",
                    "Energy degeneracy"
                ],
                correct: 2,
                explanation: "Berry phase accumulates when system parameters are varied adiabatically around a closed loop."
            },
            {
                question: "Quantum coherence is destroyed by:",
                options: [
                    "Unitary evolution",
                    "Measurement",
                    "Decoherence",
                    "Both B and C"
                ],
                correct: 3,
                explanation: "Both measurement and environmental decoherence destroy quantum coherence."
            },
            {
                question: "The Zeno effect occurs when:",
                options: [
                    "Frequent measurements slow evolution",
                    "Rare measurements speed evolution",
                    "Measurements have no effect",
                    "The system becomes classical"
                ],
                correct: 0,
                explanation: "Frequent measurements can freeze quantum evolution (quantum Zeno effect)."
            },
            {
                question: "In second quantization, particles are described by:",
                options: [
                    "Wavefunctions",
                    "Creation and annihilation operators",
                    "Classical fields",
                    "Probability distributions"
                ],
                correct: 1,
                explanation: "Second quantization treats particles as excitations created by field operators."
            },
            {
                question: "The path integral formulation is equivalent to:",
                options: [
                    "Classical mechanics",
                    "The Schr√∂dinger equation",
                    "Statistical mechanics",
                    "Relativistic quantum mechanics"
                ],
                correct: 1,
                explanation: "Feynman's path integral provides an alternative formulation equivalent to Schr√∂dinger's equation."
            },
            {
                question: "Spontaneous symmetry breaking occurs when:",
                options: [
                    "The Hamiltonian lacks symmetry",
                    "The ground state has lower symmetry than the Hamiltonian",
                    "All states have the same energy",
                    "The system is in thermal equilibrium"
                ],
                correct: 1,
                explanation: "The system chooses a ground state with less symmetry than the governing Hamiltonian."
            }
        ];

        // Selected questions for current session
        let rapidFireQuestions = [];
        let advancedQuestions = [];

        function initializeChallenges() {
            selectRandomQuestions();
            generateRapidFireQuiz();
            generateAdvancedQuiz();
            updateChallengeStats();
        }

        function selectRandomQuestions() {
            // Select 5 random questions from rapid fire bank
            rapidFireQuestions = shuffleArray([...rapidFireQuestionBank]).slice(0, 5);
            
            // Select 3 random questions from advanced bank
            advancedQuestions = shuffleArray([...advancedQuestionBank]).slice(0, 3);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function generateRapidFireQuiz() {
            const container = document.getElementById('rapidFireContent');
            let html = '';
            
            rapidFireQuestions.forEach((q, index) => {
                html += `
                    <div class="quiz-question">
                        <h4>Question ${index + 1}: ${q.question}</h4>
                        <div class="quiz-options">
                            ${q.options.map((option, optIndex) => `
                                <div class="quiz-option" onclick="selectRapidFireAnswer(${index}, ${optIndex}, this)">
                                    ${option}
                                </div>
                            `).join('')}
                        </div>
                        <div class="explanation-panel" id="rapidExplanation${index}">
                            <div class="explanation-title"><i class="fas fa-lightbulb"></i> Explanation</div>
                            <div class="explanation-content">${q.explanation}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function generateAdvancedQuiz() {
            const container = document.getElementById('advancedConceptsContent');
            let html = '';
            
            advancedQuestions.forEach((q, index) => {
                html += `
                    <div class="quiz-question">
                        <h4>Advanced Question ${index + 1}: ${q.question}</h4>
                        <div class="quiz-options">
                            ${q.options.map((option, optIndex) => `
                                <div class="quiz-option" onclick="selectAdvancedAnswer(${index}, ${optIndex}, this)">
                                    ${option}
                                </div>
                            `).join('')}
                        </div>
                        <div class="explanation-panel" id="advancedExplanation${index}">
                            <div class="explanation-title"><i class="fas fa-lightbulb"></i> Explanation</div>
                            <div class="explanation-content">${q.explanation}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function selectRapidFireAnswer(questionIndex, answerIndex, element) {
            // Remove selected class from all options in this question
            const questionDiv = element.closest('.quiz-question');
            questionDiv.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            challengeAnswers.rapidFire[questionIndex] = answerIndex;
        }

        function selectAdvancedAnswer(questionIndex, answerIndex, element) {
            // Remove selected class from all options in this question
            const questionDiv = element.closest('.quiz-question');
            questionDiv.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            challengeAnswers.advanced[questionIndex] = answerIndex;
        }

        function selectConceptualAnswer(questionIndex, answerIndex, element) {
            // Remove selected class from all options in this question
            const questionDiv = element.closest('.quiz-question');
            questionDiv.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            challengeAnswers.conceptual[questionIndex] = answerIndex;
        }

        function checkRapidFireAnswers() {
            let score = 0;
            let total = rapidFireQuestions.length;
            
            rapidFireQuestions.forEach((q, index) => {
                const userAnswer = challengeAnswers.rapidFire[index];
                const questionDiv = document.querySelector(`#rapidFireContent .quiz-question:nth-child(${index + 1})`);
                const options = questionDiv.querySelectorAll('.quiz-option');
                const explanation = document.getElementById(`rapidExplanation${index}`);
                
                options.forEach((option, optIndex) => {
                    option.classList.remove('selected', 'correct', 'incorrect');
                    if (optIndex === q.correct) {
                        option.classList.add('correct');
                    } else if (optIndex === userAnswer) {
                        option.classList.add('incorrect');
                    }
                });
                
                if (userAnswer === q.correct) {
                    score++;
                }
                
                explanation.classList.add('active');
            });
            
            showChallengeFeedback('rapidFire', score, total);
            if (score === total) {
                markChallengeComplete('rapidFire', score * 10);
            }
        }

        function checkAdvancedAnswers() {
            let score = 0;
            let total = advancedQuestions.length;
            
            advancedQuestions.forEach((q, index) => {
                const userAnswer = challengeAnswers.advanced[index];
                const questionDiv = document.querySelector(`#advancedConceptsContent .quiz-question:nth-child(${index + 1})`);
                const options = questionDiv.querySelectorAll('.quiz-option');
                const explanation = document.getElementById(`advancedExplanation${index}`);
                
                options.forEach((option, optIndex) => {
                    option.classList.remove('selected', 'correct', 'incorrect');
                    if (optIndex === q.correct) {
                        option.classList.add('correct');
                    } else if (optIndex === userAnswer) {
                        option.classList.add('incorrect');
                    }
                });
                
                if (userAnswer === q.correct) {
                    score++;
                }
                
                explanation.classList.add('active');
            });
            
            showChallengeFeedback('advanced', score, total);
            if (score === total) {
                markChallengeComplete('advanced', score * 15);
            }
        }

        function checkFillBlanks() {
            const answers = {
                blank1: ['ƒ•', 'h-bar', 'hamiltonian', '‚Ñè‚àá¬≤/(2m) + v'],
                blank2: ['n¬≤œÄ¬≤‚Ñè¬≤/(2mL¬≤)', 'n¬≤h¬≤/(8mL¬≤)', 'n¬≤ œÄ¬≤ ‚Ñè¬≤ / (2mL¬≤)'],
                blank3: ['‚Ñè/2', 'h/4œÄ', '‚Ñè / 2'],
                blank4: ['normalized', 'normalised', '1'],
                blank5: ['less than', 'below', '<', 'smaller than']
            };
            
            const questionLabels = {
                blank1: 'Hamiltonian operator',
                blank2: 'Ground state energy formula',
                blank3: 'Uncertainty principle constant',
                blank4: 'Wavefunction condition',
                blank5: 'Tunneling energy condition'
            };
            
            let score = 0;
            let total = Object.keys(answers).length;
            let detailedResults = [];
            
            Object.keys(answers).forEach(blankId => {
                const input = document.getElementById(blankId);
                const userAnswer = input.value.toLowerCase().trim();
                const correctAnswers = answers[blankId].map(ans => ans.toLowerCase());
                const originalAnswers = answers[blankId]; // Keep original case
                
                // Check if user answer is empty or blank
                if (userAnswer === '' || userAnswer.length === 0) {
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    detailedResults.push({
                        question: questionLabels[blankId],
                        userAnswer: '(blank)',
                        correctAnswer: originalAnswers[0],
                        isCorrect: false
                    });
                } else if (correctAnswers.some(ans => 
                    (userAnswer.includes(ans) && ans.length > 0) || 
                    (ans.includes(userAnswer) && userAnswer.length > 0)
                )) {
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                    score++;
                    detailedResults.push({
                        question: questionLabels[blankId],
                        userAnswer: input.value.trim(),
                        correctAnswer: originalAnswers[0],
                        isCorrect: true
                    });
                } else {
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    detailedResults.push({
                        question: questionLabels[blankId],
                        userAnswer: input.value.trim(),
                        correctAnswer: originalAnswers[0],
                        isCorrect: false
                    });
                }
            });
            
            // Show detailed feedback with correct answers
            showFillBlanksDetailedFeedback(score, total, detailedResults);
            
            if (score === total) {
                markChallengeComplete('fillBlanks', score * 8);
            }
        }

        function showFillBlanksDetailedFeedback(score, total, results) {
            const feedbackElement = document.getElementById('fillBlanksFeedback');
            const percentage = Math.round((score / total) * 100);
            
            let feedbackClass = 'success';
            let message = '';
            
            if (percentage === 100) {
                message = `üéâ Perfect! You got all ${total} questions correct!`;
            } else if (percentage >= 70) {
                message = `‚úÖ Great job! You got ${score}/${total} questions correct (${percentage}%).`;
            } else {
                message = `üìö Keep studying! You got ${score}/${total} questions correct (${percentage}%).`;
                feedbackClass = 'error';
            }
            
            // Add detailed results
            message += '<br><br><strong>Detailed Results:</strong><br>';
            results.forEach(result => {
                const icon = result.isCorrect ? '‚úÖ' : '‚ùå';
                const statusClass = result.isCorrect ? 'correct' : 'incorrect';
                message += `
                    <div style="margin: 8px 0; padding: 8px; border-radius: 4px; background: ${result.isCorrect ? '#f0f9ff' : '#fef2f2'};">
                        ${icon} <strong>${result.question}:</strong><br>
                        <span style="color: #666;">Your answer:</span> <span style="color: ${result.isCorrect ? '#059669' : '#dc2626'};">${result.userAnswer}</span><br>
                        <span style="color: #666;">Correct answer:</span> <span style="color: #059669; font-weight: 500;">${result.correctAnswer}</span>
                    </div>
                `;
            });
            
            feedbackElement.className = `challenge-feedback ${feedbackClass}`;
            feedbackElement.innerHTML = message;
            feedbackElement.style.display = 'block';
        }

        function checkCalculations() {
            const calc1Input = document.getElementById('calc1');
            const calc2Input = document.getElementById('calc2');
            
            const calc1Value = parseFloat(calc1Input.value);
            const calc2Value = parseFloat(calc2Input.value);
            
            // Expected answers
            const calc1Expected = 0.377; // eV (approximate)
            const calc2Expected = 24.3; // pm (approximate)
            
            let score = 0;
            
            // Check calculation 1 (¬±10% tolerance)
            if (Math.abs(calc1Value - calc1Expected) / calc1Expected < 0.1) {
                calc1Input.style.borderColor = '#10b981';
                score++;
            } else {
                calc1Input.style.borderColor = '#ef4444';
            }
            
            // Check calculation 2 (¬±10% tolerance)
            if (Math.abs(calc2Value - calc2Expected) / calc2Expected < 0.1) {
                calc2Input.style.borderColor = '#10b981';
                score++;
            } else {
                calc2Input.style.borderColor = '#ef4444';
            }
            
            showChallengeFeedback('calculation', score, 2);
            if (score === 2) {
                markChallengeComplete('calculation', score * 20);
            }
        }

        function selectMatchingItem(element) {
            if (element.classList.contains('matched')) return;
            
            if (selectedMatchingItems.length === 0) {
                // First item selected
                element.classList.add('selected');
                selectedMatchingItems.push(element);
            } else if (selectedMatchingItems.length === 1) {
                const firstItem = selectedMatchingItems[0];
                
                if (element === firstItem) {
                    // Same item clicked, deselect
                    element.classList.remove('selected');
                    selectedMatchingItems = [];
                } else {
                    // Second item selected, try to match
                    const firstConcept = firstItem.dataset.concept;
                    const firstDescription = firstItem.dataset.description;
                    const secondConcept = element.dataset.concept;
                    const secondDescription = element.dataset.description;
                    
                    let isValidMatch = false;
                    let matchKey = null;
                    
                    // Check if one item has concept and the other has matching description
                    if (firstConcept && secondDescription && firstConcept === secondDescription) {
                        isValidMatch = true;
                        matchKey = firstConcept;
                    } else if (firstDescription && secondConcept && firstDescription === secondConcept) {
                        isValidMatch = true;
                        matchKey = secondConcept;
                    }
                    
                    // Always allow matching (don't show if correct/incorrect until check)
                    firstItem.classList.remove('selected');
                    firstItem.classList.add('matched');
                    element.classList.add('matched');
                    
                    // Store the match for later checking
                    if (isValidMatch) {
                        matchingPairs[matchKey] = true;
                    } else {
                        // Store incorrect match with a different key
                        const incorrectKey = `${firstConcept || firstDescription}_${secondConcept || secondDescription}`;
                        matchingPairs[incorrectKey] = false;
                    }
                    
                    // Create visual connection line
                    createConnectionLine(firstItem, element);
                    
                    selectedMatchingItems = [];
                }
            }
        }

        function createConnectionLine(item1, item2) {
            const container = document.getElementById('matchingConnections');
            const rect1 = item1.getBoundingClientRect();
            const rect2 = item2.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            const line = document.createElement('div');
            line.className = 'connection-line';
            
            // Calculate positions relative to the container
            const x1 = rect1.right - containerRect.left;
            const y1 = rect1.top + rect1.height / 2 - containerRect.top;
            const x2 = rect2.left - containerRect.left;
            const y2 = rect2.top + rect2.height / 2 - containerRect.top;
            
            // Calculate line properties
            const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            line.style.cssText = `
                position: absolute;
                left: ${x1}px;
                top: ${y1}px;
                width: ${length}px;
                height: 2px;
                background: #6366f1;
                transform-origin: left center;
                transform: rotate(${angle}deg);
                z-index: 1;
            `;
            
            container.appendChild(line);
        }

        function checkMatching() {
            const expectedPairs = ['wavefunction', 'uncertainty', 'tunneling', 'quantization', 'superposition'];
            const correctAnswers = {
                'wavefunction': 'Probability amplitude describing quantum state',
                'uncertainty': 'Œîx¬∑Œîp ‚â• ‚Ñè/2 fundamental limit', 
                'tunneling': 'Particle penetration through potential barriers',
                'quantization': 'Discrete allowed energy levels in bound systems',
                'superposition': 'Linear combination of quantum states'
            };
            
            let score = 0;
            let checkedAnswers = [];
            
            // Clear previous connection line colors
            document.querySelectorAll('.connection-line').forEach(line => {
                line.style.background = '#6366f1';
            });
            
            // Check each expected pair and provide visual feedback
            expectedPairs.forEach(concept => {
                const conceptItem = document.querySelector(`[data-concept="${concept}"]`);
                const descriptionItem = document.querySelector(`[data-description="${concept}"]`);
                
                if (matchingPairs[concept]) {
                    score++;
                    checkedAnswers.push({ concept, correct: true });
                    
                    // Show correct styling
                    if (conceptItem) {
                        conceptItem.style.backgroundColor = '#dcfce7';
                        conceptItem.style.borderColor = '#16a34a';
                        conceptItem.classList.add('correct-match');
                    }
                    if (descriptionItem) {
                        descriptionItem.style.backgroundColor = '#dcfce7';
                        descriptionItem.style.borderColor = '#16a34a';
                        descriptionItem.classList.add('correct-match');
                    }
                    
                    // Color the connection line green
                    updateConnectionLineColor(conceptItem, descriptionItem, '#16a34a');
                } else {
                    checkedAnswers.push({ concept, correct: false });
                    
                    // Show what should be matched for unmatched items
                    if (conceptItem && !conceptItem.classList.contains('matched')) {
                        conceptItem.style.backgroundColor = '#fef2f2';
                        conceptItem.style.borderColor = '#ef4444';
                        conceptItem.classList.add('incorrect-match');
                    }
                    if (descriptionItem && !descriptionItem.classList.contains('matched')) {
                        descriptionItem.style.backgroundColor = '#fef2f2';
                        descriptionItem.style.borderColor = '#ef4444';
                        descriptionItem.classList.add('incorrect-match');
                    }
                }
            });
            
            // Check for incorrectly matched items
            document.querySelectorAll('.matching-item.matched').forEach(item => {
                const concept = item.dataset.concept;
                const description = item.dataset.description;
                
                if (concept && !matchingPairs[concept]) {
                    item.style.backgroundColor = '#fef2f2';
                    item.style.borderColor = '#ef4444';
                    item.classList.add('incorrect-match');
                    
                    // Find the incorrectly matched pair and color line red
                    const partnerId = findMatchedPartner(item);
                    if (partnerId) {
                        const partner = document.getElementById(partnerId) || findPartnerByPosition(item);
                        if (partner) {
                            partner.style.backgroundColor = '#fef2f2';
                            partner.style.borderColor = '#ef4444';
                            partner.classList.add('incorrect-match');
                            updateConnectionLineColor(item, partner, '#ef4444');
                        }
                    }
                } else if (description && !matchingPairs[description]) {
                    item.style.backgroundColor = '#fef2f2';
                    item.style.borderColor = '#ef4444';
                    item.classList.add('incorrect-match');
                }
            });
            
            // Show detailed feedback with answer key
            const feedbackElement = document.getElementById('matchingFeedback');
            let feedbackMessage = '';
            
            if (score === expectedPairs.length) {
                feedbackMessage = `üéâ Perfect! All ${expectedPairs.length} pairs matched correctly!`;
                feedbackElement.className = 'challenge-feedback success';
            } else {
                const percentage = Math.round((score / expectedPairs.length) * 100);
                feedbackMessage = `You matched ${score}/${expectedPairs.length} pairs correctly (${percentage}%). <br><br>`;
                
                // Add complete answer key
                feedbackMessage += '<strong>üîë Answer Key:</strong><br>';
                Object.entries(correctAnswers).forEach(([concept, description]) => {
                    const conceptText = document.querySelector(`[data-concept="${concept}"]`).textContent.trim();
                    const isCorrect = matchingPairs[concept];
                    const icon = isCorrect ? '‚úÖ' : '‚ùå';
                    feedbackMessage += `${icon} <strong>${conceptText}</strong> ‚Üí ${description}<br>`;
                });
                
                feedbackElement.className = 'challenge-feedback error';
            }
            
            feedbackElement.innerHTML = feedbackMessage;
            feedbackElement.style.display = 'block';
            
            if (score === expectedPairs.length) {
                markChallengeComplete('matching', score * 6);
            }
        }

        function updateConnectionLineColor(item1, item2, color) {
            const lines = document.querySelectorAll('.connection-line');
            const rect1 = item1.getBoundingClientRect();
            const rect2 = item2.getBoundingClientRect();
            
            lines.forEach(line => {
                const lineRect = line.getBoundingClientRect();
                // Simple check to find the line connecting these two items
                const lineY = lineRect.top + lineRect.height / 2;
                const item1Y = rect1.top + rect1.height / 2;
                const item2Y = rect2.top + rect2.height / 2;
                
                if (Math.abs(lineY - item1Y) < 5 || Math.abs(lineY - item2Y) < 5) {
                    line.style.background = color;
                }
            });
        }

        function findMatchedPartner(item) {
            // This is a simplified approach - in a more complex implementation,
            // you might want to store the relationships more explicitly
            const allMatched = document.querySelectorAll('.matching-item.matched');
            const itemRect = item.getBoundingClientRect();
            
            for (let matched of allMatched) {
                if (matched !== item) {
                    const matchedRect = matched.getBoundingClientRect();
                    // Check if items are roughly horizontally aligned (same row)
                    if (Math.abs(itemRect.top - matchedRect.top) < 50) {
                        return matched;
                    }
                }
            }
            return null;
        }

        function findPartnerByPosition(item) {
            const allMatched = document.querySelectorAll('.matching-item.matched');
            const itemRect = item.getBoundingClientRect();
            
            for (let matched of allMatched) {
                if (matched !== item) {
                    const matchedRect = matched.getBoundingClientRect();
                    // Check if items are roughly horizontally aligned (same row)
                    if (Math.abs(itemRect.top - matchedRect.top) < 50) {
                        return matched;
                    }
                }
            }
            return null;
        }

        function checkConceptualAnswers() {
            const correctAnswers = {
                1: 2, // The interference pattern disappears
                2: 4  // Both A and B are correct
            };

            const questionDetails = {
                1: {
                    question: "Double-Slit Experiment",
                    options: [
                        "The interference pattern becomes more pronounced",
                        "The interference pattern disappears",
                        "The pattern shifts but remains visible", 
                        "Nothing changes in the pattern"
                    ],
                    explanation: "When we observe which slit the particle goes through, we collapse the wave function and the particle behaves classically, destroying the interference pattern."
                },
                2: {
                    question: "Photoelectric Effect",
                    options: [
                        "Classical waves should eject electrons regardless of frequency",
                        "The energy depends on intensity, not frequency in classical theory",
                        "Classical theory predicts no electron ejection at any frequency",
                        "Both A and B are correct"
                    ],
                    explanation: "Classical physics predicts that higher intensity (more energy) should eject electrons, regardless of frequency. However, experiments show that only frequency above a threshold works, proving light comes in discrete packets (photons)."
                }
            };
            
            let score = 0;
            let total = Object.keys(correctAnswers).length;
            
            // Mark correct and incorrect answers visually
            Object.keys(correctAnswers).forEach(questionNum => {
                const userAnswer = challengeAnswers.conceptual[questionNum];
                const correctAnswer = correctAnswers[questionNum];
                const questionDiv = document.querySelector(`#conceptualChallenge .quiz-question:nth-child(${parseInt(questionNum) + 1})`);
                const options = questionDiv.querySelectorAll('.quiz-option');
                
                options.forEach((option, optIndex) => {
                    option.classList.remove('selected', 'correct', 'incorrect');
                    if (optIndex + 1 === correctAnswer) {
                        option.classList.add('correct');
                    } else if (optIndex + 1 === userAnswer) {
                        option.classList.add('incorrect');
                    }
                });
                
                if (userAnswer === correctAnswer) {
                    score++;
                }
            });
            
            // Show detailed feedback with answer key
            const feedbackElement = document.getElementById('conceptualFeedback');
            const percentage = Math.round((score / total) * 100);
            
            let feedbackMessage = '';
            let feedbackClass = 'success';
            
            if (percentage === 100) {
                feedbackMessage = `üéâ Perfect! You got all ${total} questions correct!`;
            } else {
                feedbackMessage = `You got ${score}/${total} questions correct (${percentage}%). <br><br>`;
                feedbackClass = 'error';
            }
            
            // Add answer key
            feedbackMessage += '<strong>üîë Answer Key:</strong><br>';
            Object.keys(correctAnswers).forEach(questionNum => {
                const details = questionDetails[questionNum];
                const userAnswer = challengeAnswers.conceptual[questionNum];
                const correctAnswer = correctAnswers[questionNum];
                const isCorrect = userAnswer === correctAnswer;
                const icon = isCorrect ? '‚úÖ' : '‚ùå';
                
                feedbackMessage += `
                    <div style="margin: 12px 0; padding: 12px; border-radius: 8px; background: ${isCorrect ? '#f0f9ff' : '#fef2f2'}; border: 1px solid ${isCorrect ? '#dbeafe' : '#fca5a5'};">
                        ${icon} <strong>Q${questionNum}: ${details.question}</strong><br>
                        <span style="color: #059669; font-weight: 500;">Correct Answer:</span> ${details.options[correctAnswer - 1]}<br>
                        <span style="color: #6b7280; font-size: 0.9rem; font-style: italic;">${details.explanation}</span>
                    </div>
                `;
            });
            
            feedbackElement.className = `challenge-feedback ${feedbackClass}`;
            feedbackElement.innerHTML = feedbackMessage;
            feedbackElement.style.display = 'block';
            
            if (score === total) {
                markChallengeComplete('conceptual', score * 12);
            }
        }

        function showChallengeFeedback(challengeType, score, total) {
            const feedbackElement = document.getElementById(`${challengeType}Feedback`);
            const percentage = Math.round((score / total) * 100);
            
            let feedbackClass = 'success';
            let message = '';
            
            if (percentage === 100) {
                message = `üéâ Perfect! You got all ${total} questions correct!`;
            } else if (percentage >= 70) {
                message = `‚úÖ Great job! You got ${score}/${total} questions correct (${percentage}%).`;
            } else {
                message = `üìö Keep studying! You got ${score}/${total} questions correct (${percentage}%). Review the explanations and try again.`;
                feedbackClass = 'error';
            }
            
            feedbackElement.className = `challenge-feedback ${feedbackClass}`;
            feedbackElement.innerHTML = message;
            feedbackElement.style.display = 'block';
        }

        function markChallengeComplete(challengeType, points) {
            if (!challengeStates[challengeType]) {
                challengeStates[challengeType] = true;
                challengeScores[challengeType] = points;
                totalScore += points;
                
                // Get correct challenge element
                let challengeElement;
                if (challengeType === 'rapidFire') {
                    challengeElement = document.getElementById('rapidFireChallenge');
                } else if (challengeType === 'advanced') {
                    challengeElement = document.getElementById('advancedConceptsChallenge');
                } else if (challengeType === 'fillBlanks') {
                    challengeElement = document.getElementById('fillBlanksChallenge');
                } else if (challengeType === 'calculation') {
                    challengeElement = document.getElementById('calculationChallenge');
                } else if (challengeType === 'matching') {
                    challengeElement = document.getElementById('matchingChallenge');
                } else if (challengeType === 'conceptual') {
                    challengeElement = document.getElementById('conceptualChallenge');
                }
                
                if (challengeElement) {
                    challengeElement.classList.add('completed');
                }
                
                updateChallengeStats();
            }
        }

        function updateChallengeStats() {
            const completedCount = Object.values(challengeStates).filter(state => state).length;
            const totalQuestions = 20; // Approximate total questions across all challenges
            const answeredQuestions = completedCount * 3; // Rough estimate
            
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('challengesCompleted').textContent = `${completedCount}/${totalChallenges}`;
            document.getElementById('accuracy').textContent = answeredQuestions > 0 ? 
                Math.round((totalScore / (answeredQuestions * 10)) * 100) + '%' : '0%';
            
            const progressBar = document.getElementById('overallProgress');
            const progressPercentage = (completedCount / totalChallenges) * 100;
            progressBar.style.width = progressPercentage + '%';
        }

        // Hint functions
        function showRapidFireHints() {
            document.querySelectorAll('#rapidFireContent .explanation-panel').forEach(panel => {
                panel.classList.add('active');
            });
        }

        function showAdvancedHints() {
            document.querySelectorAll('#advancedConceptsContent .explanation-panel').forEach(panel => {
                panel.classList.add('active');
            });
        }

        function showFillBlanksHint() {
            const hints = [
                "üí° The first blank is the Hamiltonian operator (ƒ§)",
                "üí° Energy levels follow n¬≤ dependence in infinite wells",
                "üí° The fundamental uncertainty relation involves ‚Ñè/2",
                "üí° Probability must integrate to 1 (normalized)",
                "üí° Tunneling occurs when E < V (barrier)"
            ];
            
            const feedbackElement = document.getElementById('fillBlanksFeedback');
            feedbackElement.innerHTML = hints.join('<br>');
            feedbackElement.className = 'challenge-feedback';
            feedbackElement.style.display = 'block';
        }

        function showCalculationHint() {
            document.getElementById('calc1Hint').classList.add('active');
            document.getElementById('calc2Hint').classList.add('active');
        }

        function showMatchingHints() {
            const hints = [
                "üí° <strong>Wave Function œà(x,t)</strong>: Contains all information about a quantum system's state",
                "üí° <strong>Heisenberg Uncertainty Principle</strong>: Fundamental limit on simultaneous knowledge of position and momentum",  
                "üí° <strong>Quantum Tunneling</strong>: Allows particles to pass through barriers even when classically forbidden",
                "üí° <strong>Energy Quantization</strong>: Bound systems can only have specific, discrete energy values",
                "üí° <strong>Quantum Superposition</strong>: Particles can exist in multiple states simultaneously"
            ];
            
            const feedbackElement = document.getElementById('matchingFeedback');
            feedbackElement.innerHTML = hints.join('<br>');
            feedbackElement.className = 'challenge-feedback';
            feedbackElement.style.display = 'block';
        }

        function showConceptualHints() {
            const hints = [
                "üí° Think about what happens to wave interference when you gain 'which-path' information",
                "üí° Classical physics treats light as continuous waves - what would this predict for photoelectric effect?"
            ];
            
            const feedbackElement = document.getElementById('conceptualFeedback');
            feedbackElement.innerHTML = hints.join('<br>');
            feedbackElement.className = 'challenge-feedback';
            feedbackElement.style.display = 'block';
        }

        function generateNewRapidFireQuestions() {
            // Clear previous feedback and selections
            document.getElementById('rapidFireFeedback').style.display = 'none';
            challengeAnswers.rapidFire = {};
            
            // Select new random questions
            rapidFireQuestions = shuffleArray([...rapidFireQuestionBank]).slice(0, 5);
            
            // Regenerate quiz
            generateRapidFireQuiz();
            
            // Remove completed status if it was completed
            const challengeElement = document.getElementById('rapidFireChallenge');
            if (challengeElement) {
                challengeElement.classList.remove('completed');
            }
        }

        function generateNewAdvancedQuestions() {
            // Clear previous feedback and selections
            document.getElementById('advancedConceptsFeedback').style.display = 'none';
            challengeAnswers.advanced = {};
            
            // Select new random questions
            advancedQuestions = shuffleArray([...advancedQuestionBank]).slice(0, 3);
            
            // Regenerate quiz
            generateAdvancedQuiz();
            
            // Remove completed status if it was completed
            const challengeElement = document.getElementById('advancedConceptsChallenge');
            if (challengeElement) {
                challengeElement.classList.remove('completed');
            }
        }

        // Score tracking for proper reset
        let challengeScores = {
            rapidFire: 0,
            advanced: 0,
            fillBlanks: 0,
            calculation: 0,
            matching: 0,
            conceptual: 0
        };

        // Reset functions
        function resetChallenge(challengeType) {
            // Subtract previous score if challenge was completed
            if (challengeStates[challengeType]) {
                totalScore -= challengeScores[challengeType];
            }
            
            // Reset state
            challengeStates[challengeType] = false;
            challengeAnswers[challengeType] = {};
            challengeScores[challengeType] = 0;
            
            // Get challenge element with proper naming
            let challengeElement;
            if (challengeType === 'rapidFire') {
                challengeElement = document.getElementById('rapidFireChallenge');
            } else if (challengeType === 'advanced') {
                challengeElement = document.getElementById('advancedConceptsChallenge');
            } else if (challengeType === 'fillBlanks') {
                challengeElement = document.getElementById('fillBlanksChallenge');
            } else if (challengeType === 'calculation') {
                challengeElement = document.getElementById('calculationChallenge');
            } else if (challengeType === 'matching') {
                challengeElement = document.getElementById('matchingChallenge');
            } else if (challengeType === 'conceptual') {
                challengeElement = document.getElementById('conceptualChallenge');
            }
            
            if (challengeElement) {
                challengeElement.classList.remove('completed');
                
                // Reset quiz options
                challengeElement.querySelectorAll('.quiz-option').forEach(option => {
                    option.classList.remove('selected', 'correct', 'incorrect');
                });
                
                // Reset fill-in-the-blank inputs
                challengeElement.querySelectorAll('.fill-blank-input').forEach(input => {
                    input.value = '';
                    input.classList.remove('correct', 'incorrect');
                    input.style.borderColor = '';
                });
                
                // Reset calculation inputs
                challengeElement.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = '';
                    input.style.borderColor = '';
                });
                
                // Reset matching items
                challengeElement.querySelectorAll('.matching-item').forEach(item => {
                    item.classList.remove('selected', 'matched', 'correct-match', 'incorrect-match');
                    // Reset visual styles
                    item.style.backgroundColor = '';
                    item.style.borderColor = '';
                });
                
                // Clear matching connections
                const connectionsContainer = document.getElementById('matchingConnections');
                if (connectionsContainer) {
                    connectionsContainer.innerHTML = '';
                }
                
                // Reset explanation panels
                challengeElement.querySelectorAll('.explanation-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                
                // Reset challenge hints
                challengeElement.querySelectorAll('.challenge-hint').forEach(hint => {
                    hint.classList.remove('active');
                });
                
                // Hide feedback
                const feedback = challengeElement.querySelector('.challenge-feedback');
                if (feedback) {
                    feedback.style.display = 'none';
                    feedback.innerHTML = '';
                }
            }
            
            // Reset specific challenge data
            if (challengeType === 'matching') {
                selectedMatchingItems = [];
                matchingPairs = {};
            }
            
            // Regenerate dynamic content with new random questions
            if (challengeType === 'rapidFire') {
                rapidFireQuestions = shuffleArray([...rapidFireQuestionBank]).slice(0, 5);
                generateRapidFireQuiz();
            } else if (challengeType === 'advanced') {
                advancedQuestions = shuffleArray([...advancedQuestionBank]).slice(0, 3);
                generateAdvancedQuiz();
            }
            
            updateChallengeStats();
        }

        function resetAllChallenges() {
            // Reset all challenge types
            Object.keys(challengeStates).forEach(challengeType => {
                resetChallenge(challengeType);
            });
            
            // Reset global variables
            totalScore = 0;
            selectedMatchingItems = [];
            matchingPairs = {};
            challengeScores = {
                rapidFire: 0,
                advanced: 0,
                fillBlanks: 0,
                calculation: 0,
                matching: 0,
                conceptual: 0
            };
            
            // Update display
            updateChallengeStats();
            
            // Select new random questions and regenerate content
            selectRandomQuestions();
            generateRapidFireQuiz();
            generateAdvancedQuiz();
        }

        // Guided tour system
        const tourSteps = [
            {
                title: "Welcome to Quantum Lab!",
                content: "Explore the fascinating world of quantum mechanics through interactive wavefunctions. This tour will guide you through hands-on exercises.",
                target: ".visualization-area",
                position: "center"
            },
            {
                title: "Exercise 1: Finding Ground State",
                content: "Use the 'Harmonic' potential and move the energy slider to find the smallest energy that eliminates the 'kink' in the wavefunction. This is the ground state energy!",
                target: ".potential-selector",
                position: "bottom",
                exercise: true,
                task: "Find the ground state energy by eliminating the wavefunction kink"
            },
            {
                title: "Visualization Controls", 
                content: "Toggle |œà|¬≤ to see probability density. Where is the particle most likely to be found in the ground state vs excited states?",
                target: ".wave-controls",
                position: "left",
                exercise: true,
                task: "Compare particle locations in ground vs excited states using |œà|¬≤"
            },
            {
                title: "Exercise 2: Quantum Tunneling",
                content: "Find the classical turning points where energy crosses potential. Can you see the wavefunction tunneling into forbidden regions?",
                target: ".quantum-controls",
                position: "left",
                exercise: true,
                task: "Observe quantum tunneling beyond classical turning points"
            },
            {
                title: "Exercise 3: Time Evolution",
                content: "Click play ‚ñ∂ to see time evolution. Add multiple energy levels with + button. Why does |œà|¬≤ move with multiple energies but not with one?",
                target: ".measurements-section",
                position: "left",
                exercise: true,
                task: "Understand interference between different energy states"
            },
            {
                title: "Exercise 4: Momentum Space",
                content: "Try the 'Infinite Well' and toggle œÜ(k) to see momentum distribution. How does momentum change with energy?",
                target: ".wave-controls",
                position: "left",
                exercise: true,
                task: "Explore momentum distributions at different energies"
            },
            {
                title: "Exercise 5: Asymmetric Potentials",
                content: "Load 'Stepped' potential. Compare asymmetric position wavefunction with its momentum distribution. What do you notice?",
                target: ".potential-selector",
                position: "bottom",
                exercise: true,
                task: "Compare symmetry in position vs momentum space"
            },
            {
                title: "Challenge Yourself!",
                content: "Test your understanding with quantum mechanics questions in the Challenges tab.",
                target: ".experiment-tabs button:nth-child(2)",
                position: "bottom"
            },
            {
                title: "Ready to Explore!",
                content: "You've completed the quantum exercises tour! Continue exploring and use the help button if needed.<br><br>üîó <strong>Want more quantum exercises and advanced features?</strong><br><a href='https://ridiculousfish.com/wavefiz/' target='_blank' style='color: #6366f1; text-decoration: underline;'>Visit the original WaveFiz for additional experiments and information</a>",
                target: ".container",
                position: "center"
            }
        ];

        function handleTourButtonClick() {
            // Check if user is on mobile and continuing
            if (mobileDetection && mobileDetection.isContinuingOnMobile()) {
                // Show mobile-friendly help instead of tour
                showMobileHelp();
            } else if (window.DISABLE_GUIDED_TOUR) {
                // Show a message that tour is disabled
                alert('Guided tour is disabled on this device for better user experience.');
            } else {
                // Start the normal guided tour
                startGuidedTour();
            }
        }

        function showMobileHelp() {
            // Create a mobile-friendly help overlay
            const helpDialog = document.createElement('div');
            helpDialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
                padding: 20px;
            `;
            
            const helpContent = document.createElement('div');
            helpContent.style.cssText = `
                background: white;
                padding: 24px;
                border-radius: 12px;
                max-width: 380px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
                text-align: left;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            helpContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: #1f2937; font-size: 1.2rem;">üì± Mobile Quick Guide</h3>
                    <button id="closeMobileHelp" style="
                        background: none;
                        border: none;
                        font-size: 18px;
                        cursor: pointer;
                        padding: 4px;
                        color: #6b7280;
                    ">√ó</button>
                </div>
                <div style="color: #374151; line-height: 1.5; font-size: 14px;">
                    <p style="margin-bottom: 12px;"><strong>Basic Controls:</strong></p>
                    <ul style="margin-bottom: 16px; padding-left: 20px;">
                        <li>Tap potential buttons to change quantum systems</li>
                        <li>Use checkboxes to toggle wave visualizations</li>
                        <li>Add/remove energy levels with + and - buttons</li>
                        <li>Try the Challenges tab for quantum questions</li>
                    </ul>
                    
                    <p style="margin-bottom: 12px;"><strong>Quantum Concepts:</strong></p>
                    <ul style="margin-bottom: 16px; padding-left: 20px;">
                        <li><strong>œà(x,t):</strong> The wavefunction (real part)</li>
                        <li><strong>|œà|¬≤:</strong> Probability density of finding particle</li>
                        <li><strong>œÜ(k):</strong> Momentum space wavefunction</li>
                        <li><strong>Energy levels:</strong> Quantized energy states</li>
                    </ul>
                    
                    <p style="margin-bottom: 12px;"><strong>Quick Experiments:</strong></p>
                    <ul style="margin-bottom: 16px; padding-left: 20px;">
                        <li>Try "Harmonic" potential and adjust energy</li>
                        <li>Compare |œà|¬≤ for different energy levels</li>
                        <li>Observe quantum tunneling in barriers</li>
                        <li>Test your knowledge in Challenges</li>
                    </ul>
                    
                    <p style="color: #6b7280; font-size: 12px; margin-top: 16px;">
                        üí° For full interactive experience with guided exercises, 
                        please visit on a desktop computer.
                    </p>
                </div>
            `;
            
            helpDialog.appendChild(helpContent);
            document.body.appendChild(helpDialog);
            
            // Add event listeners
            document.getElementById('closeMobileHelp').addEventListener('click', () => {
                document.body.removeChild(helpDialog);
            });
            
            // Close on outside click
            helpDialog.addEventListener('click', (e) => {
                if (e.target === helpDialog) {
                    document.body.removeChild(helpDialog);
                }
            });
        }

        function startGuidedTour() {
            // Check if tour is disabled (e.g., for mobile users)
            if (window.DISABLE_GUIDED_TOUR || (mobileDetection && mobileDetection.isContinuingOnMobile())) {
                console.log('Guided tour is disabled');
                return;
            }
            
            tourActive = true;
            currentTourStep = 0;
            
            // Reset overlay styles to ensure proper display
            const tourOverlay = document.getElementById('tourOverlay');
            const tourPopup = document.getElementById('tourPopup');
            
            if (!tourOverlay || !tourPopup) {
                console.error('Tour elements not found');
                return;
            }
            
            tourOverlay.style.display = '';
            tourOverlay.style.visibility = '';
            tourOverlay.style.opacity = '';
            tourOverlay.style.pointerEvents = '';
            tourPopup.style.display = '';
            
            showTourStep();
            
            // Add escape key handler
            document.addEventListener('keydown', handleTourKeydown);
        }

        function handleTourKeydown(event) {
            if (!tourActive) return;
            
            if (event.key === 'Escape') {
                event.preventDefault();
                endTour(); // This will show the confirmation popup
            } else if (event.key === 'ArrowRight' || event.key === 'Space') {
                event.preventDefault();
                nextTourStep();
            } else if (event.key === 'ArrowLeft') {
                event.preventDefault();
                prevTourStep();
            }
        }

        function showTourStep() {
            if (currentTourStep >= tourSteps.length) {
                forceEndTour();
                return;
            }

            const step = tourSteps[currentTourStep];
            console.log('Showing tour step:', currentTourStep, step);
            
            const overlay = document.getElementById('tourOverlay');
            const popup = document.getElementById('tourPopup');
            const spotlight = document.getElementById('tourSpotlight');

            if (!overlay || !popup || !spotlight) {
                console.error('Tour elements not found');
                return;
            }

            // Show overlay
            overlay.classList.add('active');
            
            // Update popup content
            const titleElement = document.getElementById('tourTitle');
            const counterElement = document.getElementById('tourStepCounter');
            const contentElement = document.getElementById('tourContent');
            
            if (titleElement) titleElement.textContent = step.title;
            if (counterElement) counterElement.textContent = `Step ${currentTourStep + 1} of ${tourSteps.length}`;
            
            if (contentElement) {
                let content = step.content;
                if (step.exercise && step.task) {
                    content += `
                        <div class="tour-exercise">
                            <div class="tour-exercise-label">
                                <i class="fas fa-flask"></i> Exercise Task:
                            </div>
                            <div class="tour-exercise-task">${step.task}</div>
                        </div>
                    `;
                }
                contentElement.innerHTML = content;
            }
            
            // Position spotlight and popup
            const target = document.querySelector(step.target);
            if (target) {
                const rect = target.getBoundingClientRect();
                const popupWidth = 380; // max-width from CSS
                const popupHeight = 200; // estimated height
                const margin = 20;
                
                // Position spotlight
                spotlight.style.left = rect.left - 10 + 'px';
                spotlight.style.top = rect.top - 10 + 'px';
                spotlight.style.width = rect.width + 20 + 'px';
                spotlight.style.height = rect.height + 20 + 'px';
                
                // Special handling for center position or final step
                if (step.position === "center" || currentTourStep === tourSteps.length - 1) {
                    // Center the popup on screen
                    popup.style.left = '50%';
                    popup.style.top = '50%';
                    popup.style.transform = 'translate(-50%, -50%)';
                } else {
                    // Smart popup positioning for other steps
                    let popupLeft = rect.right + margin;
                    let popupTop = rect.top;
                    
                    // Check if popup goes off right edge
                    if (popupLeft + popupWidth > window.innerWidth) {
                        // Try positioning to the left
                        popupLeft = rect.left - popupWidth - margin;
                        
                        // If still off screen, position in center
                        if (popupLeft < 0) {
                            popupLeft = (window.innerWidth - popupWidth) / 2;
                            popupTop = rect.bottom + margin;
                            
                            // If goes off bottom, position above
                            if (popupTop + popupHeight > window.innerHeight) {
                                popupTop = rect.top - popupHeight - margin;
                                
                                // If still off top, position in center
                                if (popupTop < 0) {
                                    popupTop = (window.innerHeight - popupHeight) / 2;
                                }
                            }
                        }
                    }
                    
                    // Check if popup goes off top or bottom
                    if (popupTop < margin) {
                        popupTop = margin;
                    } else if (popupTop + popupHeight > window.innerHeight - margin) {
                        popupTop = window.innerHeight - popupHeight - margin;
                    }
                    
                    // Ensure minimum margins
                    popupLeft = Math.max(margin, Math.min(popupLeft, window.innerWidth - popupWidth - margin));
                    
                    popup.style.left = popupLeft + 'px';
                    popup.style.top = popupTop + 'px';
                    popup.style.transform = 'none'; // Reset any transform
                }
                
            } else {
                console.error('Tour target not found:', step.target);
                // Position popup in center if target not found
                popup.style.left = '50%';
                popup.style.top = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
            }
            
            // Show/hide Try It button for exercises
            const tryBtn = document.getElementById('tourTryBtn');
            if (tryBtn) {
                if (step.exercise) {
                    tryBtn.style.display = 'block';
                } else {
                    tryBtn.style.display = 'none';
                }
            }
            
            popup.classList.add('active');
        }

        function setupCurrentExercise() {
            const step = tourSteps[currentTourStep];
            if (!step.exercise) return;
            
            // Check if visualizer is ready
            if (!Vis) {
                console.warn('Visualizer not ready, delaying exercise setup');
                setTimeout(() => setupCurrentExercise(), 500);
                return;
            }
            
            switch(currentTourStep) {
                case 1: // Ground State Exercise
                    try {
                        // Find the SHO button more specifically
                        const shoButton = document.querySelector('.potential-btn[onclick*="SHO"]') || 
                                        document.querySelector('.potential-btn.active') ||
                                        document.querySelector('.potential-btn');
                        
                        if (shoButton) {
                            loadPotential('SHO', shoButton);
                        } else {
                            console.warn('SHO button not found, calling loadPotential without button');
                            // Try to load SHO without button reference
                            if (Vis && Vis.loadSHO) {
                                Vis.loadSHO();
                            }
                        }
                        
                        // Safely remove extra energy levels with a counter to prevent infinite loops
                        let maxAttempts = 10;
                        let attempts = 0;
                        
                        while (document.querySelectorAll('.dragger').length > 2 && attempts < maxAttempts) {
                            removeEnergyLevel();
                            attempts++;
                        }
                        
                        // Use setTimeout to avoid blocking the UI
                        setTimeout(() => {
                            alert("Try moving the energy slider to find the smallest energy that eliminates the 'kink' in the wavefunction!");
                        }, 100);
                    } catch (error) {
                        console.error('Error in Ground State Exercise setup:', error);
                        alert("Exercise setup ready! Try moving the energy slider to find the ground state.");
                    }
                    break;
                    
                case 2: // Probability Density
                    try {
                        const psiAbsCheckbox = document.getElementById('check_psiAbs');
                        if (psiAbsCheckbox) {
                            psiAbsCheckbox.checked = true;
                            psiAbsCheckbox.dispatchEvent(new Event('change'));
                        }
                    } catch (error) {
                        console.error('Error in Probability Density setup:', error);
                    }
                    break;
                    
                case 3: // Quantum Tunneling
                    try {
                        const fswButton = document.querySelector('.potential-btn[onclick*="FSW"]');
                        if (fswButton) {
                            loadPotential('FSW', fswButton);
                        }
                    } catch (error) {
                        console.error('Error in Quantum Tunneling setup:', error);
                    }
                    break;
                    
                case 4: // Time Evolution
                    try {
                        addEnergyLevel();
                    } catch (error) {
                        console.error('Error in Time Evolution setup:', error);
                    }
                    break;
                    
                case 5: // Momentum Space
                    try {
                        const iswButton = document.querySelector('.potential-btn[onclick*="ISW"]');
                        if (iswButton) {
                            loadPotential('ISW', iswButton);
                        }
                        
                        const phiCheckbox = document.getElementById('check_phi');
                        if (phiCheckbox) {
                            phiCheckbox.checked = true;
                            phiCheckbox.dispatchEvent(new Event('change'));
                        }
                    } catch (error) {
                        console.error('Error in Momentum Space setup:', error);
                    }
                    break;
                    
                case 6: // Asymmetric Potentials
                    try {
                        const steppedButton = document.querySelector('.potential-btn[onclick*="stepped"]');
                        if (steppedButton) {
                            loadPotential('stepped', steppedButton);
                        }
                        
                        const phiCheckbox = document.getElementById('check_phi');
                        if (phiCheckbox) {
                            phiCheckbox.checked = true;
                            phiCheckbox.dispatchEvent(new Event('change'));
                        }
                    } catch (error) {
                        console.error('Error in Asymmetric Potentials setup:', error);
                    }
                    break;
                    
                default:
                    console.log('No exercise setup for step:', currentTourStep);
            }
        }

        function nextTourStep() {
            currentTourStep++;
            showTourStep();
        }

        function prevTourStep() {
            if (currentTourStep > 0) {
                currentTourStep--;
                showTourStep();
            }
        }

        function endTour() {
            // Create a custom confirmation dialog
            const confirmDialog = document.createElement('div');
            confirmDialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
            `;
            
            const dialogContent = document.createElement('div');
            dialogContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 12px;
                max-width: 450px;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            dialogContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <h3 style="margin: 0 0 15px 0; color: #1f2937; font-size: 1.3rem;">Skip Quantum Tour?</h3>
                <p style="color: #6b7280; line-height: 1.6; margin-bottom: 25px;">
                    The guided tour helps you understand the quantum simulation controls and concepts. 
                    Without it, the simulation might be difficult to navigate and understand.
                </p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="cancelSkip" style="
                        background: #6366f1;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                    ">Continue Tour</button>
                    <button id="confirmSkip" style="
                        background: #ef4444;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                    ">Skip Tour</button>
                </div>
            `;
            
            confirmDialog.appendChild(dialogContent);
            document.body.appendChild(confirmDialog);
            
            // Add event listeners
            document.getElementById('cancelSkip').addEventListener('click', () => {
                document.body.removeChild(confirmDialog);
            });
            
            document.getElementById('confirmSkip').addEventListener('click', () => {
                document.body.removeChild(confirmDialog);
                forceEndTour();
            });
            
            // Close on outside click
            confirmDialog.addEventListener('click', (e) => {
                if (e.target === confirmDialog) {
                    document.body.removeChild(confirmDialog);
                }
            });
        }

        function forceEndTour() {
            const tourOverlay = document.getElementById('tourOverlay');
            const tourPopup = document.getElementById('tourPopup');
            
            // Remove active classes
            tourOverlay.classList.remove('active');
            tourPopup.classList.remove('active');
            
            // Explicitly ensure overlay is completely hidden and non-interactive
            tourOverlay.style.display = 'none';
            tourOverlay.style.visibility = 'hidden';
            tourOverlay.style.opacity = '0';
            tourOverlay.style.pointerEvents = 'none';
            
            // Reset popup
            tourPopup.style.display = 'none';
            
            tourActive = false;
            currentTourStep = 0;
            document.removeEventListener('keydown', handleTourKeydown);
            
            // Ensure body interactions are restored
            document.body.style.pointerEvents = '';
        }

        // Help panel
        function toggleHelp() {
            const helpPanel = document.getElementById('helpPanel');
            helpPanelVisible = !helpPanelVisible;
            
            if (helpPanelVisible) {
                helpPanel.classList.add('active');
            } else {
                helpPanel.classList.remove('active');
            }
        }

        // Add some helper styles for alerts
        const alertStyles = `
            .alert {
                padding: 12px;
                margin: 10px 0;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .alert-success {
                background: #ecfdf5;
                color: #065f46;
                border: 1px solid #a7f3d0;
            }
            .alert-warning {
                background: #fef3c7;
                color: #92400e;
                border: 1px solid #fbbf24;
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = alertStyles;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>